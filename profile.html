<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile | Gold Coast RP</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .profile-container { display: flex; gap: 2em; max-width: 1200px; margin: 2em auto; }
    .profile-sidebar { background: #181a20; border-radius: 1em; padding: 2em 1.5em; min-width: 220px; box-shadow: 0 2px 16px #0002; display: flex; flex-direction: column; gap: 1.5em; }
    .profile-sidebar .sidebar-link { color: #b3b3b3; text-decoration: none; font-weight: 600; padding: 0.7em 1em; border-radius: 0.7em; transition: background 0.2s, color 0.2s; display: flex; align-items: center; gap: 0.7em; }
    .profile-sidebar .sidebar-link.active, .profile-sidebar .sidebar-link:hover { background: #23272a; color: #fff; }
    .theme-toggle { margin-top: 2em; cursor: pointer; color: #7289da; font-size: 1.2em; text-align: center; }
    .profile-main { flex: 1; }
    .profile-banner { position: relative; height: 180px; background: linear-gradient(90deg, #23272a 60%, #5865f2 100%); border-radius: 1em 1em 0 0; overflow: hidden; }
    .profile-avatar { position: absolute; left: 2em; bottom: -60px; width: 120px; height: 120px; border-radius: 50%; border: 5px solid #181a20; object-fit: cover; background: #23272a; }
    .profile-info-card { background: #181a20; border-radius: 0 0 1em 1em; box-shadow: 0 2px 16px #0002; padding: 5em 2em 2em 2em; margin-top: -60px; display: flex; flex-direction: column; gap: 1.2em; }
    .profile-header { display: flex; align-items: center; gap: 1.5em; }
    .profile-header-main { flex: 1; }
    .profile-username { font-size: 2em; font-weight: 700; color: #fff; }
    .profile-discord { color: #7289da; font-size: 1.1em; margin-top: 0.2em; }
    .profile-roles { margin: 0.5em 0; }
    .profile-role { display: inline-block; background: #23272a; color: #fff; border-radius: 1em; padding: 0.3em 1em; margin: 0 0.3em 0.3em 0; font-size: 1em; }
    .profile-badges { margin: 0.5em 0; }
    .badge { display: inline-block; background: #5865f2; color: #fff; border-radius: 1em; padding: 0.3em 1em; margin: 0 0.2em 0.5em 0.2em; font-size: 0.95em; }
    .profile-stats { display: flex; gap: 2em; margin: 1em 0; }
    .stat-card { background: #23272a; color: #fff; border-radius: 0.7em; padding: 1em 1.5em; text-align: center; min-width: 100px; }
    .stat-label { color: #b3b3b3; font-size: 0.95em; }
    .stat-value { font-size: 1.3em; font-weight: 700; }
    .profile-bio { color: #b3b3b3; margin: 1em 0; font-size: 1.1em; }
    .profile-actions { display: flex; gap: 1em; margin-top: 1em; }
    .profile-actions .btn { min-width: 120px; }
    .profile-edit-form { background: #23272a; border-radius: 1em; padding: 2em; margin-top: 1em; display: none; flex-direction: column; gap: 1em; }
    .profile-edit-form input, .profile-edit-form textarea { width: 100%; padding: 0.7em; border-radius: 0.5em; border: none; background: #181a20; color: #fff; }
    .profile-edit-form label { color: #b3b3b3; font-weight: 600; }
    .profile-edit-form .btn { width: auto; }
    .profile-section { background: #181a20; border-radius: 1em; padding: 2em; margin-top: 2em; box-shadow: 0 2px 16px #0002; }
    .activity-list { margin-top: 1em; }
    .activity-item { color: #fff; margin-bottom: 1em; display: flex; align-items: center; gap: 1em; }
    .activity-icon { color: #7289da; font-size: 1.2em; }
    @media (max-width: 900px) {
      .profile-container { flex-direction: column; gap: 0; }
      .profile-sidebar { flex-direction: row; min-width: 0; padding: 1em; border-radius: 1em 1em 0 0; }
      .profile-main { padding: 0 0.5em; }
      .profile-banner { height: 120px; }
      .profile-avatar { width: 80px; height: 80px; left: 1em; bottom: -40px; border-width: 3px; }
      .profile-info-card { padding: 3em 1em 1em 1em; margin-top: -40px; }
    }
    @media (max-width: 600px) {
      .profile-info-card, .profile-section { padding: 1em; }
      .profile-banner { height: 80px; }
      .profile-avatar { width: 60px; height: 60px; left: 0.5em; bottom: -30px; }
      .profile-info-card { margin-top: -30px; }
    }
  </style>
</head>
<body class="dark-bg">
  <!-- Navbar -->
  <nav class="navbar main-navbar">
    <div class="navbar-left">
      <img src="/goldcoast-badge.png" alt="Gold Coast RP Logo" class="navbar-logo" />
      <span class="site-title">Gold Coast RP</span>
    </div>
    <ul class="navbar-menu">
      <li><a href="/">Home</a></li>
      <li class="dropdown">
        <span>Departments</span>
        <ul class="dropdown-menu">
          <li><a href="/lspd">LSPD</a></li>
          <li><a href="/bcso">BCSO</a></li>
          <li><a href="/lsfd">LSFD</a></li>
          <li><a href="/sahp">SAHP</a></li>
          <li><a href="/sacd">SACD</a></li>
          <li><a href="/civilian">Civilian</a></li>
        </ul>
      </li>
      <li><a href="/events">Events</a></li>
      <li><a href="/resources">Resources</a></li>
      <li><a href="https://discord.gg/yourdiscord" target="_blank">Join Discord</a></li>
    </ul>
    <div class="navbar-auth" id="navbar-auth">
      <button id="openSignIn" class="btn btn-primary">Sign In</button>
      <button id="openSignUp" class="btn btn-secondary">Sign Up</button>
    </div>
    <div id="navbar-user" style="display:none;"></div>
  </nav>
  <div class="profile-container">
    <!-- Sidebar -->
    <aside class="profile-sidebar">
      <a href="#profile" class="sidebar-link active"><i class="fa fa-user"></i> Profile</a>
      <a href="#security" class="sidebar-link"><i class="fa fa-lock"></i> Security</a>
      <a href="#activity" class="sidebar-link"><i class="fa fa-list"></i> Activity</a>
      <a href="#settings" class="sidebar-link"><i class="fa fa-cog"></i> Settings</a>
      <div class="theme-toggle" id="themeToggle"><i class="fa fa-moon"></i> Toggle Theme</div>
    </aside>
    <!-- Main Profile Content -->
    <main class="profile-main">
      <div class="profile-banner">
        <img id="profile-avatar" class="profile-avatar" src="/default-avatar.png" alt="User Avatar" />
      </div>
      <div class="profile-info-card">
        <div class="profile-header">
          <div class="profile-header-main">
            <div class="profile-username" id="profile-username">Username</div>
            <div class="profile-discord" id="profile-discord"><i class="fab fa-discord"></i> Discord#0000 <span id="discord-status" style="font-size:0.8em;"></span></div>
            <div class="profile-roles" id="profile-roles"></div>
            <div class="profile-badges" id="profile-badges"></div>
          </div>
          <div class="profile-actions">
            <button id="edit-profile-btn" class="btn btn-secondary"><i class="fa fa-pen"></i> Edit</button>
            <button id="logout-btn" class="btn btn-primary"><i class="fa fa-sign-out-alt"></i> Logout</button>
          </div>
        </div>
        <div class="profile-stats" id="profile-stats">
          <!-- Stats will be injected here -->
        </div>
        <div class="profile-bio" id="profile-bio">This is your bio. Tell us about yourself!</div>
        <form id="edit-profile-form" class="profile-edit-form">
          <label for="edit-avatar">Avatar</label>
          <input type="file" id="edit-avatar" accept="image/*">
          <label for="edit-username">Username</label>
          <input type="text" id="edit-username" maxlength="32">
          <label for="edit-discord">Discord Tag</label>
          <input type="text" id="edit-discord" maxlength="32">
          <label for="edit-bio">Bio</label>
          <textarea id="edit-bio" rows="3" maxlength="500"></textarea>
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
        </form>
      </div>
      <!-- Activity Section -->
      <section class="profile-section" id="activity-section">
        <h3><i class="fa fa-list"></i> Recent Activity</h3>
        <div class="activity-list" id="activity-list"></div>
      </section>
    </main>
  </div>
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <span>&copy; 2025 Gold Coast RP. All rights reserved.</span>
      <span class="footer-links">
        <a href="/">Home</a> |
        <a href="/departments">Departments</a> |
        <a href="/events">Events</a> |
        <a href="/resources">Resources</a>
      </span>
    </div>
  </footer>
  <script src="auth-modals.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Profile] DOMContentLoaded');
      // --- Error Display ---
      let errorDiv = document.getElementById('profile-error');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'profile-error';
        errorDiv.style.color = '#ff5555';
        errorDiv.style.background = '#23272a';
        errorDiv.style.padding = '1em';
        errorDiv.style.margin = '1em 0';
        errorDiv.style.borderRadius = '8px';
        errorDiv.style.display = 'none';
        document.querySelector('.profile-main').prepend(errorDiv);
      }
      function showError(msg) {
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
        console.error('[Profile] ' + msg);
      }
      function hideError() {
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
      }

      // --- Theme Toggle ---
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.onclick = function() {
        document.body.classList.toggle('light-bg');
        document.body.classList.toggle('dark-bg');
        localStorage.setItem('theme', document.body.classList.contains('light-bg') ? 'light' : 'dark');
      };
      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-bg');
        document.body.classList.remove('dark-bg');
      }

      // --- Robust Profile Tabs Logic (always query sections fresh) ---
      const sidebarLinks = document.querySelectorAll('.sidebar-link');
      const sectionIds = {
        profile: 'profile-info-card',
        security: 'security-section',
        activity: 'activity-section',
        settings: 'settings-section'
      };
      function showSection(key) {
        let found = false;
        Object.keys(sectionIds).forEach(k => {
          const el = document.getElementById(sectionIds[k]);
          if (el) {
            el.style.display = (k === key) ? '' : 'none';
            if (k === key) found = true;
          }
        });
        sidebarLinks.forEach(link => {
          if (link.getAttribute('href') === '#' + key) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
        if (!found) {
          showError('Section for tab "' + key + '" not found in DOM.');
        } else {
          hideError();
        }
        console.log('[Profile] showSection:', key, 'found:', found);
      }
      // On tab click: update hash and show section
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const hash = this.getAttribute('href');
          if (window.location.hash !== hash) {
            window.location.hash = hash;
          } else {
            showSection(hash.replace('#', ''));
          }
        });
      });
      // On hash change or page load, show correct section
      function handleHash() {
        const hash = window.location.hash.replace('#', '');
        if (sectionIds[hash]) {
          showSection(hash);
        } else {
          showSection('profile');
        }
      }
      window.addEventListener('hashchange', handleHash);
      handleHash(); // Initial

      // --- Profile Fetch Logic ---
      function getUsernameFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('user');
      }
      async function fetchProfileByUsername(username) {
        try {
          console.log('[Profile] Fetching user profile for', username);
          const res = await fetch(`/api/users/profile/${encodeURIComponent(username)}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          if (!data.success || !data.user) throw new Error('User not found');
          return data.user;
        } catch (err) {
          showError('User not found or error fetching user: ' + err.message);
          setTimeout(() => { window.location.href = '/'; }, 2000);
        }
      }
      async function fetchLoggedInProfile() {
        const token = localStorage.getItem('gcrp_token') || sessionStorage.getItem('gcrp_token');
        if (!token) {
          showError('Not logged in. Redirecting...');
          setTimeout(() => { window.location.href = '/'; }, 2000);
          return null;
        }
        try {
          console.log('[Profile] Fetching logged-in user profile');
          const res = await fetch('/api/profile', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          if (!data.success || !data.user) throw new Error('User not found');
          return data.user;
        } catch (err) {
          showError('Error fetching your profile: ' + err.message);
          setTimeout(() => { window.location.href = '/'; }, 2000);
          return null;
        }
      }
      async function fetchMe() {
        const token = localStorage.getItem('gcrp_token') || sessionStorage.getItem('gcrp_token');
        if (!token) return null;
        try {
          console.log('[Profile] Fetching /api/auth/me');
          const res = await fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          if (!data.success || !data.user) throw new Error('Not logged in');
          return data.user;
        } catch (err) {
          showError('Error fetching auth info: ' + err.message);
          return null;
        }
      }
      function renderStats(user) {
        const stats = [
          { label: 'Joined', value: user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-' },
          { label: 'Last Login', value: user.lastLogin ? new Date(user.lastLogin).toLocaleString() : '-' },
          { label: 'Applications', value: user.applications?.length || 0 },
          { label: 'Departments', value: user.departments?.length || 0 },
        ];
        document.getElementById('profile-stats').innerHTML = stats.map(s => `<div class=\"stat-card\"><div class=\"stat-value\">${s.value}</div><div class=\"stat-label\">${s.label}</div></div>`).join('');
      }
      function renderProfile(user, isOwnProfile) {
        hideError();
        document.getElementById('profile-avatar').src = user.avatar || '/default-avatar.png';
        document.getElementById('profile-username').textContent = user.username;
        document.getElementById('profile-discord').innerHTML = `<i class='fab fa-discord'></i> ${user.discord || 'Not linked'} <span id='discord-status'></span>`;
        const rolesDiv = document.getElementById('profile-roles');
        rolesDiv.innerHTML = '';
        (user.roles || []).forEach(role => {
          const span = document.createElement('span');
          span.className = 'profile-role';
          span.textContent = role.name;
          rolesDiv.appendChild(span);
        });
        const badgesDiv = document.getElementById('profile-badges');
        badgesDiv.innerHTML = '';
        (user.badges || []).forEach(badge => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = badge;
          badgesDiv.appendChild(span);
        });
        renderStats(user);
        document.getElementById('profile-bio').textContent = user.bio || '';
        document.getElementById('edit-profile-btn').style.display = isOwnProfile ? '' : 'none';
      }
      async function renderActivity(user) {
        try {
          const res = await fetch(`/api/users/${user.id}/activity`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const activityList = document.getElementById('activity-list');
          activityList.innerHTML = '';
          (data.activity || []).forEach(item => {
            const div = document.createElement('div');
            div.className = 'activity-item';
            div.innerHTML = `<span class='activity-icon'><i class='fa fa-${item.icon || 'bolt'}'></i></span> <span>${item.text}</span> <span style='color:#b3b3b3;font-size:0.9em;'>${new Date(item.date).toLocaleString()}</span>`;
            activityList.appendChild(div);
          });
        } catch (err) {
          showError('Could not load activity: ' + err.message);
        }
      }
      // --- Edit Profile Logic ---
      const editBtn = document.getElementById('edit-profile-btn');
      const editForm = document.getElementById('edit-profile-form');
      const cancelEdit = document.getElementById('cancel-edit');
      if (editBtn && editForm && cancelEdit) {
        editBtn.onclick = function() {
          editForm.style.display = 'flex';
          fetchLoggedInProfile().then(user => {
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-discord').value = user.discord || '';
            document.getElementById('edit-bio').value = user.bio || '';
          });
        };
        cancelEdit.onclick = function() {
          editForm.style.display = 'none';
        };
        editForm.onsubmit = async function(e) {
          e.preventDefault();
          const username = document.getElementById('edit-username').value;
          const discord = document.getElementById('edit-discord').value;
          const bio = document.getElementById('edit-bio').value;
          try {
            await fetch('/api/users/profile', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ username, discord, bio })
            });
            const file = document.getElementById('edit-avatar').files[0];
            if (file) {
              const formData = new FormData();
              formData.append('avatar', file);
              await fetch('/api/users/avatar', {
                method: 'POST',
                credentials: 'include',
                body: formData
              });
            }
            editForm.style.display = 'none';
            loadProfile();
          } catch (err) {
            showError('Error saving profile: ' + err.message);
          }
        };
      } else {
        showError('Edit profile elements not found in DOM.');
      }
      document.getElementById('logout-btn').onclick = function() {
        localStorage.removeItem('gcrp_token');
        sessionStorage.removeItem('gcrp_token');
        window.location.href = '/';
      };
      // --- Load Profile ---
      async function loadProfile() {
        hideError();
        const urlUser = getUsernameFromUrl();
        let user = null;
        let isOwnProfile = false;
        if (urlUser) {
          user = await fetchProfileByUsername(urlUser);
          const me = await fetchMe();
          isOwnProfile = me && me.username && me.username.toLowerCase() === urlUser.toLowerCase();
        } else {
          user = await fetchLoggedInProfile();
          isOwnProfile = true;
        }
        if (!user) return;
        renderProfile(user, isOwnProfile);
        renderActivity(user);
      }
      loadProfile();
      if (typeof updateNavbarUser === 'function') {
        try {
          updateNavbarUser();
        } catch (err) {
          showError('Navbar update failed: ' + err.message);
        }
      } else {
        showError('updateNavbarUser is not defined. Navbar will not update.');
      }
    });
  </script>
</body>
</html> 